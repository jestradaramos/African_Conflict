<html>
	<head>
		<title>Suicide Attacks</title>
		<script src='https://d3js.org/d3.v4.min.js'></script>
		<script src='africa.js'></script>
	</head>
	<body>
		<script>

			var width = 500,
				height = 700;
			var svg = d3.select('body')
						.append('svg')
						.attr('width', width)
						.attr('height', height);
			var g = svg.append('g');
			var recProjection = d3.geoEquirectangular()
						.scale(300)
						.rotate([0, 0])
						.center([0, 42.313])
						.translate([width/5, height/15]);
			var geoPath = d3.geoPath()
						.projection(recProjection);
			g.selectAll('path')
				.data(map_json.features)
				.enter()
				.append('path')
				.attr('fill','#ccc')
				.attr('stroke', '#000')
				.attr('d', geoPath);


			d3.csv("/csv/african_conflicts.csv", function(datum){
				datum = datum.filter(function(d){
					if (isNaN(d.LONGITUDE)){
						return false;
					}
					if (isNaN(d.LATITUDE)){
						return false;
					}
					if (isNaN(d.FATALITIES)){

						return false;
					}

					d.LONGITUDE = parseFloat(d.LONGITUDE);
					d.LATITUDE = parseFloat(d.LATITUDE);
					d.FATALITIES = +d.FATALITIES;
					return true;
				})

				var grouped = d3.nest()
							.key(function(d) { return d.COUNTRY; })
							.rollup(function(v) { return {
								total: d3.sum(v, function(d){ return d.FATALITIES; }),
								lon: d3.mean(v, function(d) { return d.LONGITUDE; }),
								lat: d3.mean(v, function(d) { return d.LATITUDE; })

							}})
							.entries(datum);

				console.log(grouped);
				var max = d3.max(grouped, function(d) { return d.value.total; }),
					min = d3.min(grouped, function(d) { return d.value.total; });
				svg.selectAll("circle")
							.data(grouped).enter()
							.append("circle")
							.attr("cx", function(d) { 
								console.log(d.value.total);
								return recProjection([d.value.lon,
									d.value.lat])[0]; })
							.attr("cy", function(d) { 
								return recProjection([d.value.lon,
									d.value.lat])[1]; })
							.attr("r", function(d) {
								var killed = (d.value.total - min)/(max - min)
									*50;
								console.log(killed);
								console.log(d.value.total);
								return "" + killed + "px";
							})
							.attr("fill", "red")
							.attr("opacity", "0.5");
				

			});
		
		</script>
	</body>

</html>
